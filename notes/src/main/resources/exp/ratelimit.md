# 背景
如何通过合理的设计，实现一个满足易用、易扩展、灵
活、低延时、高容错等非功能性需求的限流框架。

# 限流规则
框架需要定义限流规则的语法格式，包括调用方、接口、限流阈值、时间粒度这几个元素。

其
中，unit 表示限流时间粒度，默认情况下是 1 秒。limit 表示在 unit 时间粒度内最大允许
的请求次数。拿第一条规则来举例，它表示的意思就是：调用方 app-1 对接口 /v1/user
每分钟的最大请求次数不能超过 100 次。
```xml
configs:
- appId: app-1
    limits:
    - api: /v1/user
    limit: 100
    unit：60
    - api: /v1/order
    limit: 50
- appId: app-2
    limits:
    - api: /v1/user
    limit: 50
    - api: /v1/order
    limit: 50
```
> 对于限流时间粒度的选择，我们既可以选择限制 1 秒钟内不超过 1000 次，也可以选择限
制 10 毫秒内不超过 10 次，还可以选择限制 1 分钟内不超过 6 万次。虽然看起来这几种限
流规则是等价的，但过大的时间粒度会达不到限流的效果。比如，有可能 6 万次请求集中
在 1 秒中到达，限制 1 分钟不超过 6 万次，就起不到保护的作用；相反，因为接口访问在
细时间粒度上随机性很大，并不会很均匀。过小的时间粒度，会误杀很多本不应该限流的请
求。所以，尽管越细的时间粒度限流整形效果越好，流量曲线越平滑，但也并不是时间粒度
越小越合适。


# 限流算法
常见的限流算法有：固定时间窗口限流算法、滑动时间窗口限流算法、令牌桶限流算法、漏桶限流算法。

尽管固定时间窗口限流算法没法做到让流量很平滑，但大部分情况下，它已经够用了。默认情况下，框架使用固定时间窗口限流算法做限流。不过，考虑到框架的扩展性，我们需要预
先做好设计，预留好扩展点，方便今后扩展其他限流算法。

> 框架要低延迟。限流逻辑的执行不能占用太长时间，不能或者很少影响接口请求本身的响应时间。因为分布式限流基于外部存储 Redis，网络通信成本较
高，实际上，高容错、低延迟设计的主要场景就是基于 Redis 实现的分布式限流。

# 代码实现

https://github.com/wangzheng0822/ratelimiter4j


