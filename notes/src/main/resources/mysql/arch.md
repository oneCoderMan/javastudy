# MySQL架构
MySQL的逻辑架构图如下，MySQL可以分为**Server层**和**存储引擎层**两部分

| 组件     | 功能                                    |
|--------|---------------------------------------|
| Server层 | 连接器、查询缓存、分析器、优化器、执行器等，涵盖MySQL的大多数核心服务功能 |
| 存储引擎   | 负责数据的存储和提取。其架构模式是插件式的，支持InnoDB、MyISAM、Memory等多个存储引擎                                     |

> 默认使用的就是InnoDB，MySQL8.0没有查询缓存模块

<div align="center">
	<img src="https://github.com/oneCoderMan/javastudy/blob/f70fb795b40a00913f8d89e5efb69a5c7af213ea/notes/src/main/resources/mysql/pics/arch.png" alt="Editor" width="500">
</div>

# 连接器
连接器负责跟客户端建立连接、获取权限、维持和管理连接

一个简单的创建连接的命令
```
mysql -h$ip -P$port -u$user -p
```

过程：用来跟服务端建立连接 -> 在完成经典的TCP握手 -> 连接器会到权限表里面查出你拥有的权限 -> 权限判断逻辑 -> 没有后续的动作，这个连接就处于空闲状态 
-> 客户端如果太长时间没动静，连接器就会自动将它断开（wait_timeout控制的，默认值是8小时）

> 过程通常是比较复杂的，尽量减少建立连接的动作

# 分析器
分析器负责SQL语句的词法分析和语法分析，语义分析

# 优化器
负责优化SQL语句的查询


一些优化case
* 有多个索引的时候，决定使用哪个索引
* 在一个语句有多表关联（join）的时候，决定各个表的连接顺序

# 执行器
MySQL通过分析器知道了你要做什么，通过优化器知道了该怎么做，于是就进入了执行器阶段，开始执行语句。

过程：验证表的查询权限 -> 打开表 -> 调用引擎提供的接口进行数据行的读取 -> 讲符合条件的数据组装 -> 返回数据给客户端


# 问题
## 题目
1. 一个用户成功建立连接后，用管理员账号对这个用户的权限做了修改，会影响已经存在连接的权限吗？
2. 什么是长连接？什么是短连接？
3. 如果长连接累积下来，可能导致内存占用太大，被系统强行杀掉（OOM），导致MySQL异常重启，如何解决
4. 如果表T中没有字段k，而你执行了这个语句`select * from T where k=1`, 那肯定是会报“不存在这个列”的错误： `Unknown column ‘k’ in ‘where clause’`。这个错误是在上面提到的哪个阶段报出来？


## 答案
1. 不会影响，这个连接里面的权限判断逻辑，都将依赖于一开始读到的权限表记录
2. 数据库里面，长连接是指连接成功后，如果客户端持续有请求，则一直使用同一个连接。短连接则是指每次执行完很少的几次查询就断开连接，下次查询再重新建立一个。
3. a）程序里面判断执行过一个占用内存的大查询后，断开连接，之后要查询再重；b)MySQL 5.7或更新版本，可以在每次执行一个比较大的操作后，通过执行 mysql_reset_connection来重新初始化连接资源。这个过程不需要重连和重新做权限验证，但是会将连接恢复到刚刚创建完时的状态。
4. 分析器；在做语法分析的时候会